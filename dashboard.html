<!DOCTYPE html>
<html>
<head>
  <title>Real Estate Investment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1c1c1c);
      color: white;
    }

    .container {
      max-width: 500px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.5);
    }

    .balance {
      font-size: 36px;
      font-weight: bold;
      color: #00ff88;
      margin-top: 10px;
    }

    .logout {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg, #ff3b3b, #b00020);
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }

    .history-item {
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 13px;
      color: #ccc;
    }

    .section-title {
      font-size: 13px;
      color: #aaa;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }
  </style>
</head>

<body>

<div class="container">

  <h1>Real Estate Investment</h1>

  <div class="card">
    <div class="section-title">ACCOUNT</div>
    <div>Email: <span id="userEmail"></span></div>
    <div class="balance">$<span id="balance">0.00</span></div>
  </div>

  <div class="card">
    <div class="section-title">PORTFOLIO GROWTH</div>
    <canvas id="growthChart"></canvas>
  </div>

  <div class="card">
    <div class="section-title">TRANSACTIONS</div>
    <div id="history"></div>
  </div>

  <button class="logout" onclick="logout()">Logout</button>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, collection, query, where, getDocs 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* âœ… YOUR REAL FIREBASE CONFIG ALREADY INSERTED */
const firebaseConfig = {
  apiKey: "AIzaSyDmUL2bFsNdyBbTWMrnY-yaKI8hAWqLynI",
  authDomain: "real-estate-investment-360d2.firebaseapp.com",
  projectId: "real-estate-investment-360d2",
  storageBucket: "real-estate-investment-360d2.firebasestorage.app",
  messagingSenderId: "459495660687",
  appId: "1:459495660687:web:2595afa1e611a9757364fa",
  measurementId: "G-9FTJ7LMDJD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userEmail = document.getElementById("userEmail");
const balanceEl = document.getElementById("balance");
const historyDiv = document.getElementById("history");

let chart;

function formatDate(timestamp) {
  if (!timestamp) return "";
  return timestamp.toDate().toLocaleDateString();
}

function updateChart(labels, dataPoints) {
  const ctx = document.getElementById("growthChart");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        data: dataPoints,
        borderColor: "#00ff88",
        backgroundColor: "rgba(0,255,136,0.15)",
        fill: true,
        tension: 0.45,
        pointRadius: 3
      }]
    },
    options: {
      plugins: { legend: { display: false }},
      scales: {
        x: { ticks: { color: "#aaa" }},
        y: { ticks: { color: "#aaa" }}
      }
    }
  });
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  userEmail.textContent = user.email;

  const depositsQuery = query(
    collection(db, "deposits"),
    where("email", "==", user.email)
  );

  const withdrawalsQuery = query(
    collection(db, "withdrawals"),
    where("email", "==", user.email)
  );

  const depositSnap = await getDocs(depositsQuery);
  const withdrawSnap = await getDocs(withdrawalsQuery);

  let transactions = [];

  depositSnap.forEach(doc => {
    const data = doc.data();
    if (data.status === "Approved" && data.createdAt) {
      transactions.push({
        type: "deposit",
        amount: Number(data.amount),
        date: data.createdAt
      });
    }
  });

  withdrawSnap.forEach(doc => {
    const data = doc.data();
    if (data.status === "Approved" && data.createdAt) {
      transactions.push({
        type: "withdraw",
        amount: Number(data.amount),
        date: data.createdAt
      });
    }
  });

  transactions.sort((a, b) => a.date.seconds - b.date.seconds);

  let runningBalance = 0;
  let labels = [];
  let dataPoints = [];

  historyDiv.innerHTML = "";

  transactions.forEach(tx => {
    if (tx.type === "deposit") {
      runningBalance += tx.amount;
    } else {
      runningBalance -= tx.amount;
    }

    labels.push(formatDate(tx.date));
    dataPoints.push(runningBalance);

    historyDiv.innerHTML += `
      <div class="history-item">
        ${tx.type.toUpperCase()} - $${tx.amount}
      </div>
    `;
  });

  balanceEl.textContent = runningBalance.toFixed(2);
  updateChart(labels, dataPoints);
});

window.logout = function() {
  signOut(auth).then(() => {
    window.location.href = "index.html";
  });
};

</script>

</body>
</html>